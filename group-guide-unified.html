<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Group Guide - ATL ESnet</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --embassy-navy: #003057;
            --embassy-blue: #0057A0;
            --embassy-gold: #C7A961;
            --embassy-light-blue: #E8F1F8;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, var(--embassy-navy) 0%, var(--embassy-blue) 100%);
            min-height: 100vh;
            display: flex;
        }

        /* Hamburger Menu Button (Mobile Only) */
        .hamburger {
            display: none;
            position: fixed;
            top: 20px;
            left: 20px;
            z-index: 1001;
            background: white;
            border: none;
            padding: 10px;
            border-radius: 8px;
            cursor: pointer;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
        }

        .hamburger span {
            display: block;
            width: 25px;
            height: 3px;
            background: var(--embassy-navy);
            margin: 5px 0;
            transition: 0.3s;
        }

        .hamburger.active span:nth-child(1) {
            transform: rotate(-45deg) translate(-5px, 6px);
        }

        .hamburger.active span:nth-child(2) {
            opacity: 0;
        }

        .hamburger.active span:nth-child(3) {
            transform: rotate(45deg) translate(-5px, -6px);
        }

        /* Sidebar Navigation */
        .sidebar {
            width: 280px;
            background: white;
            min-height: 100vh;
            box-shadow: 2px 0 10px rgba(0, 0, 0, 0.1);
            position: fixed;
            left: 0;
            top: 0;
            overflow-y: auto;
            transition: transform 0.3s ease;
            z-index: 1000;
        }

        .sidebar-header {
            background: var(--embassy-navy);
            color: white;
            padding: 25px 20px;
            text-align: center;
            border-bottom: 3px solid var(--embassy-gold);
        }

        .sidebar-header h1 {
            font-size: 24px;
            margin-bottom: 5px;
        }

        .sidebar-header p {
            font-size: 12px;
            opacity: 0.9;
        }

        .sidebar-nav {
            padding: 20px 0;
        }

        .nav-section {
            margin-bottom: 25px;
        }

        .nav-section-title {
            padding: 10px 20px;
            font-size: 11px;
            font-weight: 700;
            text-transform: uppercase;
            color: #94a3b8;
            letter-spacing: 0.5px;
        }

        .nav-link {
            display: block;
            padding: 12px 20px;
            color: #334155;
            text-decoration: none;
            transition: all 0.2s ease;
            border-left: 3px solid transparent;
        }

        .nav-link:hover {
            background: var(--embassy-light-blue);
            border-left-color: var(--embassy-blue);
        }

        .nav-link.active {
            background: var(--embassy-light-blue);
            border-left-color: var(--embassy-blue);
            color: var(--embassy-navy);
            font-weight: 600;
        }

        /* Main Content Area */
        .main-content {
            margin-left: 280px;
            flex: 1;
            padding: 40px 20px;
            width: calc(100% - 280px);
        }

        /* Date/Time Display */
        .datetime-display {
            position: absolute;
            top: 20px;
            right: 40px;
            color: var(--embassy-gold);
            font-size: 14px;
            font-weight: 600;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.3);
            z-index: 100;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .loading {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            font-size: 24px;
            color: white;
            width: 100%;
        }

        .header {
            background: white;
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        }

        .header h1 {
            color: var(--embassy-navy);
            font-size: 32px;
            margin-bottom: 5px;
        }

        .header .subtitle {
            color: #666;
            font-size: 14px;
        }

        .controls-card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 30px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            display: flex;
            gap: 15px;
            align-items: center;
            flex-wrap: wrap;
        }

        .add-group-btn {
            padding: 12px 25px;
            background: var(--embassy-blue);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .add-group-btn:hover {
            background: var(--embassy-navy);
            transform: translateY(-2px);
        }

        .ai-upload-btn {
            background: var(--embassy-gold);
        }

        .ai-upload-btn:hover {
            background: #b89950;
        }

        .search-input {
            flex: 1;
            min-width: 250px;
            padding: 12px 20px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s ease;
        }

        .search-input:focus {
            outline: none;
            border-color: var(--embassy-blue);
        }

        .filter-select {
            padding: 12px 20px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 14px;
            cursor: pointer;
            background: white;
            transition: border-color 0.3s ease;
        }

        .filter-select:focus {
            outline: none;
            border-color: var(--embassy-blue);
        }

        .content-card {
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            margin-bottom: 30px;
        }

        .content-card h2 {
            color: var(--embassy-navy);
            font-size: 24px;
            margin-bottom: 25px;
        }

        .groups-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 20px;
        }

        .group-card {
            background: #f8fafc;
            border-radius: 12px;
            padding: 20px;
            border: 2px solid #e2e8f0;
            transition: all 0.3s ease;
        }

        .group-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.1);
            border-color: var(--embassy-blue);
        }

        .group-card-header {
            display: flex;
            justify-content: space-between;
            align-items: start;
            margin-bottom: 15px;
        }

        .group-name {
            font-size: 18px;
            font-weight: 700;
            color: var(--embassy-navy);
            margin-bottom: 5px;
        }

        .status-badge {
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .status-upcoming {
            background: #fef3c7;
            color: #92400e;
        }

        .status-in-house {
            background: #d1fae5;
            color: #065f46;
        }

        .status-past {
            background: #e5e7eb;
            color: #374151;
        }

        .group-dates {
            color: #64748b;
            font-size: 14px;
            margin-bottom: 12px;
        }

        .group-info {
            margin: 15px 0;
        }

        .group-info-row {
            display: flex;
            font-size: 14px;
            margin-bottom: 8px;
            color: #475569;
        }

        .group-info-label {
            font-weight: 600;
            min-width: 100px;
            color: #334155;
        }

        .action-buttons {
            display: flex;
            gap: 10px;
            margin-top: 15px;
            flex-wrap: wrap;
        }

        .btn-small {
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .btn-view {
            background: var(--embassy-blue);
            color: white;
        }

        .btn-view:hover {
            background: var(--embassy-navy);
        }

        .btn-edit {
            background: var(--embassy-gold);
            color: white;
        }

        .btn-edit:hover {
            background: #b89950;
        }

        .btn-delete {
            background: #dc2626;
            color: white;
        }

        .btn-delete:hover {
            background: #b91c1c;
        }

        .no-groups {
            text-align: center;
            padding: 60px 20px;
            color: #64748b;
        }

        .no-groups-icon {
            font-size: 64px;
            margin-bottom: 20px;
        }

        /* AI Upload Section */
        .upload-section {
            display: none;
            margin-top: 20px;
        }

        .upload-section.show {
            display: block;
        }

        .upload-area {
            border: 3px dashed #cbd5e1;
            border-radius: 12px;
            padding: 40px;
            text-align: center;
            transition: all 0.3s ease;
            background: #f8fafc;
            cursor: pointer;
            margin-bottom: 20px;
        }

        .upload-area:hover {
            border-color: var(--embassy-blue);
            background: var(--embassy-light-blue);
        }

        .upload-area.dragover {
            border-color: var(--embassy-gold);
            background: #fef3c7;
        }

        .upload-icon {
            font-size: 48px;
            margin-bottom: 15px;
        }

        .upload-area h3 {
            color: var(--embassy-navy);
            margin-bottom: 10px;
            font-size: 18px;
        }

        .upload-area p {
            color: #666;
            margin-bottom: 15px;
            font-size: 14px;
        }

        .file-input {
            display: none;
        }

        .file-info {
            background: var(--embassy-light-blue);
            border-left: 4px solid var(--embassy-blue);
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: none;
        }

        .file-info.show {
            display: block;
        }

        .file-info p {
            color: #475569;
            font-size: 14px;
            margin: 5px 0;
        }

        .processing {
            text-align: center;
            padding: 40px;
            display: none;
        }

        .processing.show {
            display: block;
        }

        .spinner {
            border: 4px solid #e2e8f0;
            border-top: 4px solid var(--embassy-blue);
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .preview-groups {
            display: none;
        }

        .preview-groups.show {
            display: block;
        }

        .preview-group {
            background: #f8fafc;
            border: 2px solid #e2e8f0;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 15px;
        }

        .preview-group h3 {
            color: var(--embassy-navy);
            font-size: 18px;
            margin-bottom: 15px;
        }

        .preview-row {
            display: grid;
            grid-template-columns: 150px 1fr;
            gap: 10px;
            margin-bottom: 10px;
        }

        .preview-label {
            font-weight: 600;
            color: #475569;
        }

        .preview-value {
            color: #1e293b;
        }

        .upload-actions {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-top: 20px;
        }

        .btn {
            padding: 12px 30px;
            background: var(--embassy-blue);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn:hover {
            background: var(--embassy-navy);
            transform: translateY(-2px);
        }

        .btn:disabled {
            background: #94a3b8;
            cursor: not-allowed;
            transform: none;
        }

        .btn-secondary {
            background: #64748b;
        }

        .btn-secondary:hover {
            background: #475569;
        }

        .btn-gold {
            background: var(--embassy-gold);
        }

        .btn-gold:hover {
            background: #b89950;
        }

        .alert {
            padding: 15px 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: none;
        }

        .alert.show {
            display: block;
        }

        .alert-success {
            background: #d1fae5;
            border-left: 4px solid #10b981;
            color: #065f46;
        }

        .alert-error {
            background: #fee2e2;
            border-left: 4px solid #ef4444;
            color: #991b1b;
        }

        /* Modals */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            z-index: 2000;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: 15px;
            max-width: 600px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        }

        .modal-header {
            background: var(--embassy-navy);
            color: white;
            padding: 25px;
            border-radius: 15px 15px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-header h3 {
            font-size: 24px;
            margin: 0;
        }

        .close-modal {
            background: none;
            border: none;
            color: white;
            font-size: 32px;
            cursor: pointer;
            padding: 0;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: background 0.2s ease;
        }

        .close-modal:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        .modal-content form {
            padding: 25px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        label {
            display: block;
            font-weight: 600;
            color: #334155;
            margin-bottom: 8px;
            font-size: 14px;
        }

        input[type="text"],
        input[type="email"],
        input[type="tel"],
        input[type="date"],
        input[type="number"],
        textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 14px;
            font-family: inherit;
            transition: border-color 0.3s ease;
        }

        input:focus,
        textarea:focus {
            outline: none;
            border-color: var(--embassy-blue);
        }

        textarea {
            min-height: 100px;
            resize: vertical;
        }

        .submit-button {
            width: 100%;
            padding: 15px;
            background: var(--embassy-blue);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .submit-button:hover {
            background: var(--embassy-navy);
        }

        .submit-button:disabled {
            background: #94a3b8;
            cursor: not-allowed;
        }

        /* View Modal Specific Styles */
        .detail-section {
            padding: 20px 25px;
            border-bottom: 1px solid #e2e8f0;
        }

        .detail-section:last-child {
            border-bottom: none;
        }

        .detail-dates {
            font-size: 16px;
            color: var(--embassy-navy);
            font-weight: 600;
            margin-bottom: 10px;
        }

        .detail-label {
            font-weight: 700;
            color: var(--embassy-navy);
            font-size: 14px;
            margin-bottom: 8px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .detail-value {
            margin-bottom: 8px;
            font-size: 15px;
            color: #334155;
        }

        .vip-box,
        .notes-box {
            background: #f8fafc;
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid var(--embassy-gold);
            margin-top: 10px;
            white-space: pre-wrap;
            font-size: 14px;
            color: #334155;
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .hamburger {
                display: block;
            }

            .sidebar {
                transform: translateX(-100%);
            }

            .sidebar.active {
                transform: translateX(0);
            }

            .main-content {
                margin-left: 0;
                width: 100%;
                padding-top: 80px;
            }

            .datetime-display {
                position: static;
                text-align: center;
                margin-bottom: 20px;
            }

            .header {
                text-align: center;
            }

            .groups-grid {
                grid-template-columns: 1fr;
            }

            .form-row {
                grid-template-columns: 1fr;
            }

            .controls-card {
                flex-direction: column;
            }

            .search-input {
                width: 100%;
            }

            .preview-row {
                grid-template-columns: 1fr;
            }

            .upload-actions {
                flex-direction: column;
            }
        }

        @media (max-width: 1024px) and (min-width: 769px) {
            .sidebar {
                width: 240px;
            }

            .main-content {
                margin-left: 240px;
                width: calc(100% - 240px);
            }
        }
    </style>
    
    <!-- Mammoth.js for DOCX extraction -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.6.0/mammoth.browser.min.js"></script>
</head>
<body>
    <!-- Hamburger Menu Button -->
    <button class="hamburger" id="hamburger" onclick="toggleSidebar()">
        <span></span>
        <span></span>
        <span></span>
    </button>

    <!-- Sidebar Navigation -->
    <nav class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <h1>ATL ESnet</h1>
            <p>Embassy Suites Centennial Park</p>
        </div>
        <div class="sidebar-nav">
            <div class="nav-section">
                <a href="index.html" class="nav-link">üè† Dashboard Home</a>
            </div>

            <div class="nav-section">
                <div class="nav-section-title">Guest Services</div>
                <a href="training-binder.html" class="nav-link">üìö Training Binder</a>
                <a href="room-reference.html" class="nav-link">üö™ Room Reference</a>
                <a href="group-guide.html" class="nav-link active">üë• Group Guide</a>
                <a href="attractions.html" class="nav-link">üé° Nearby Attractions</a>
            </div>

            <div class="nav-section">
                <div class="nav-section-title">Hotel Dining</div>
                <a href="restaurant-info.html" class="nav-link">üçΩÔ∏è Restaurant Info</a>
            </div>

            <div class="nav-section">
                <div class="nav-section-title">Management</div>
                <a href="mod-communications.html" class="nav-link">üì¢ MOD Communications</a>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="main-content">
        <div class="datetime-display" id="currentDateTime"></div>

        <div class="loading" id="loading">
            Loading Group Guide...
        </div>

        <div class="container" id="groupGuidePage" style="display: none;">
            <div class="header">
                <h1>üë• Group Guide</h1>
                <p class="subtitle">Manage group reservations and in-house groups</p>
            </div>

            <!-- Alert Messages -->
            <div id="alertSuccess" class="alert alert-success"></div>
            <div id="alertError" class="alert alert-error"></div>

            <div class="controls-card">
                <button class="add-group-btn" id="addGroupBtn" onclick="openAddGroupModal()" style="display: none;">
                    ‚ûï Add Group
                </button>
                <button class="add-group-btn ai-upload-btn" id="aiUploadBtn" onclick="toggleUploadSection()" style="display: none;">
                    ü§ñ AI Upload
                </button>
                <input type="text" class="search-input" id="searchInput" placeholder="üîç Search groups by name, contact, or company...">
                <select class="filter-select" id="statusFilter">
                    <option value="all">All Groups</option>
                    <option value="upcoming">Upcoming</option>
                    <option value="in-house">In-House</option>
                    <option value="past">Past</option>
                </select>
            </div>

            <!-- AI Upload Section -->
            <div class="content-card upload-section" id="uploadSection">
                <h2>ü§ñ AI Document Upload</h2>
                <p style="color: #666; margin-bottom: 20px;">
                    Upload a document containing group reservation information, and our AI will automatically extract the data.
                </p>

                <div class="upload-area" id="uploadArea">
                    <div class="upload-icon">üì§</div>
                    <h3>Drop your file here or click to browse</h3>
                    <p>Supported formats: PDF, DOCX, XLSX, TXT (Max 10MB)</p>
                    <button class="btn btn-gold" onclick="document.getElementById('fileInput').click()">
                        Choose File
                    </button>
                    <input type="file" id="fileInput" class="file-input" accept=".pdf,.docx,.xlsx,.txt" onchange="handleFileSelect(event)">
                </div>

                <div class="file-info" id="fileInfo">
                    <p><strong>üìé Selected File:</strong> <span id="fileName"></span></p>
                    <p><strong>Size:</strong> <span id="fileSize"></span></p>
                </div>

                <div style="text-align: center; margin-top: 20px;">
                    <button class="btn btn-gold" id="processBtn" onclick="processDocument()" disabled>
                        ü§ñ Process with AI
                    </button>
                </div>

                <div class="processing" id="processingSection">
                    <div class="spinner"></div>
                    <h3 style="color: var(--embassy-navy); margin-bottom: 10px;">Processing Document...</h3>
                    <p style="color: #666;">Claude AI is analyzing your document and extracting group information.</p>
                </div>

                <div class="preview-groups" id="previewGroups">
                    <h3 style="color: var(--embassy-navy); margin: 30px 0 20px;">üëÅÔ∏è Preview Extracted Groups</h3>
                    <div id="groupPreviews"></div>
                    
                    <div class="upload-actions">
                        <button class="btn" onclick="saveExtractedGroups()">
                            üíæ Save All to Database
                        </button>
                        <button class="btn btn-secondary" onclick="cancelUpload()">
                            ‚ùå Cancel
                        </button>
                    </div>
                </div>
            </div>

            <!-- Groups Display -->
            <div class="content-card">
                <h2>Current & Upcoming Groups</h2>
                <div class="groups-grid" id="groupsGrid">
                    <div class="no-groups">
                        <div class="no-groups-icon">üìã</div>
                        <p>No groups found.</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- View Details Modal -->
    <div class="modal" id="viewModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="viewModalTitle">Group Details</h3>
                <button class="close-modal" onclick="closeViewModal()">√ó</button>
            </div>
            <div id="viewModalContent" style="line-height: 1.8;">
                <!-- Content will be populated by JavaScript -->
            </div>
        </div>
    </div>

    <!-- Add/Edit Group Modal -->
    <div class="modal" id="groupModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="modalTitle">Add New Group</h3>
                <button class="close-modal" onclick="closeModal()">√ó</button>
            </div>
            <form id="groupForm">
                <div class="form-group">
                    <label for="groupName">Group Name *</label>
                    <input type="text" id="groupName" required placeholder="e.g., Atlanta Tech Summit">
                </div>

                <div class="form-group">
                    <label for="company">Company/Organization</label>
                    <input type="text" id="company" placeholder="e.g., Tech Corp Inc">
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="arrivalDate">Arrival Date *</label>
                        <input type="date" id="arrivalDate" required>
                    </div>
                    <div class="form-group">
                        <label for="departureDate">Departure Date *</label>
                        <input type="date" id="departureDate" required>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="roomBlock">Room Block</label>
                        <input type="number" id="roomBlock" min="1" placeholder="e.g., 50">
                    </div>
                    <div class="form-group">
                        <label for="roomsPicked">Rooms Picked Up</label>
                        <input type="number" id="roomsPicked" min="0" placeholder="e.g., 45">
                    </div>
                </div>

                <div class="form-group">
                    <label for="contactName">Primary Contact Name</label>
                    <input type="text" id="contactName" placeholder="e.g., John Smith">
                </div>

                <div class="form-group">
                    <label for="contactPhone">Contact Phone</label>
                    <input type="tel" id="contactPhone" placeholder="e.g., (404) 555-0123">
                </div>

                <div class="form-group">
                    <label for="contactEmail">Contact Email</label>
                    <input type="email" id="contactEmail" placeholder="e.g., john@example.com">
                </div>

                <div class="form-group">
                    <label for="vipNames">VIP Names</label>
                    <textarea id="vipNames" placeholder="List VIP guests (one per line)"></textarea>
                </div>

                <div class="form-group">
                    <label for="specialRequests">Special Requests / Notes</label>
                    <textarea id="specialRequests" placeholder="Any special requests, dietary restrictions, room preferences, etc."></textarea>
                </div>

                <button type="submit" class="submit-button" id="submitBtn">Save Group</button>
            </form>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getAuth, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
        import { getFirestore, collection, addDoc, getDocs, doc, getDoc, updateDoc, deleteDoc, query, orderBy } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';
        import { firebaseConfig } from './firebase-config.js';

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        let currentUser = null;
        let currentUserProfile = null;
        let allGroups = [];
        let editingGroupId = null;
        let selectedFile = null;
        let extractedGroups = [];

        // Toggle Sidebar for Mobile
        window.toggleSidebar = function() {
            const sidebar = document.getElementById('sidebar');
            const hamburger = document.getElementById('hamburger');
            sidebar.classList.toggle('active');
            hamburger.classList.toggle('active');
        };

        // Close sidebar when clicking outside on mobile
        document.addEventListener('click', function(event) {
            const sidebar = document.getElementById('sidebar');
            const hamburger = document.getElementById('hamburger');
            
            if (window.innerWidth <= 768 && 
                sidebar.classList.contains('active') && 
                !sidebar.contains(event.target) && 
                !hamburger.contains(event.target)) {
                sidebar.classList.remove('active');
                hamburger.classList.remove('active');
            }
        });

        // Update date and time display
        function updateDateTime() {
            const now = new Date();
            const options = { 
                weekday: 'short', 
                year: 'numeric', 
                month: 'short', 
                day: 'numeric',
                hour: 'numeric',
                minute: '2-digit',
                second: '2-digit',
                hour12: true
            };
            const dateTimeString = now.toLocaleDateString('en-US', options);
            const dateTimeElement = document.getElementById('currentDateTime');
            if (dateTimeElement) {
                dateTimeElement.textContent = dateTimeString;
            }
        }

        updateDateTime();
        setInterval(updateDateTime, 1000);

        // Toggle upload section
        window.toggleUploadSection = function() {
            const uploadSection = document.getElementById('uploadSection');
            uploadSection.classList.toggle('show');
            
            if (!uploadSection.classList.contains('show')) {
                cancelUpload();
            }
        };

        // Drag and drop handlers
        const uploadArea = document.getElementById('uploadArea');

        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.classList.add('dragover');
        });

        uploadArea.addEventListener('dragleave', () => {
            uploadArea.classList.remove('dragover');
        });

        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                handleFile(files[0]);
            }
        });

        // File selection handler
        window.handleFileSelect = function(event) {
            const file = event.target.files[0];
            if (file) {
                handleFile(file);
            }
        };

        // Handle file
        function handleFile(file) {
            // Validate file size (10MB max)
            if (file.size > 10 * 1024 * 1024) {
                showAlert('error', 'File is too large. Maximum size is 10MB.');
                return;
            }

            // Validate file type
            const allowedTypes = ['application/pdf', 'application/vnd.openxmlformats-officedocument.wordprocessingml.document', 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet', 'text/plain'];
            if (!allowedTypes.includes(file.type)) {
                showAlert('error', 'Invalid file type. Please upload PDF, DOCX, XLSX, or TXT files.');
                return;
            }

            selectedFile = file;

            // Display file info
            document.getElementById('fileName').textContent = file.name;
            document.getElementById('fileSize').textContent = (file.size / 1024).toFixed(2) + ' KB';
            document.getElementById('fileInfo').classList.add('show');
            document.getElementById('processBtn').disabled = false;

            hideAllAlerts();
        }

        // Process document with Claude API via Firebase Cloud Function
        window.processDocument = async function() {
            if (!selectedFile) return;

            // Show processing
            document.getElementById('processingSection').classList.add('show');
            document.getElementById('processBtn').disabled = true;

            try {
                // Read file content
                const fileContent = await readFileContent(selectedFile);

                // Call Firebase Cloud Function (solves CORS issue)
                // Get your Firebase project ID from Firebase Console
                const projectId = firebaseConfig.projectId;
                const functionUrl = `https://us-central1-${projectId}.cloudfunctions.net/processGroupDocument`;

                const response = await fetch(functionUrl, {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                    },
                    body: JSON.stringify({
                        content: fileContent
                    })
                });

                if (!response.ok) {
                    throw new Error(`API request failed: ${response.status}`);
                }

                const data = await response.json();
                const aiResponse = data.content[0].text;

                // Parse JSON response
                const parsedData = JSON.parse(aiResponse);
                extractedGroups = parsedData.groups || [];

                if (extractedGroups.length === 0) {
                    throw new Error('No groups found in document');
                }

                // Display preview
                displayGroupPreviews();

            } catch (error) {
                console.error('Processing error:', error);
                showAlert('error', `Failed to process document: ${error.message}`);
                document.getElementById('processingSection').classList.remove('show');
                document.getElementById('processBtn').disabled = false;
            }
        };

        // Read file content
        async function readFileContent(file) {
            const fileName = file.name.toLowerCase();
            
            // Handle DOCX files with mammoth.js
            if (fileName.endsWith('.docx')) {
                return new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onload = async (e) => {
                        try {
                            const arrayBuffer = e.target.result;
                            const result = await mammoth.extractRawText({ arrayBuffer: arrayBuffer });
                            resolve(result.value);
                        } catch (error) {
                            reject(error);
                        }
                    };
                    reader.onerror = reject;
                    reader.readAsArrayBuffer(file);
                });
            }
            
            // Handle text files
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = (e) => resolve(e.target.result);
                reader.onerror = reject;
                reader.readAsText(file);
            });
        }

        // Display group previews
        function displayGroupPreviews() {
            const container = document.getElementById('groupPreviews');
            container.innerHTML = '';

            extractedGroups.forEach((group, index) => {
                const preview = document.createElement('div');
                preview.className = 'preview-group';
                preview.innerHTML = `
                    <h3>${group.groupName}</h3>
                    ${group.company ? `<div class="preview-row">
                        <div class="preview-label">Company:</div>
                        <div class="preview-value">${group.company}</div>
                    </div>` : ''}
                    <div class="preview-row">
                        <div class="preview-label">Dates:</div>
                        <div class="preview-value">${formatDate(group.arrivalDate)} - ${formatDate(group.departureDate)}</div>
                    </div>
                    ${group.roomBlock ? `<div class="preview-row">
                        <div class="preview-label">Room Block:</div>
                        <div class="preview-value">${group.roomBlock} rooms</div>
                    </div>` : ''}
                    ${group.roomsPicked ? `<div class="preview-row">
                        <div class="preview-label">Rooms Picked Up:</div>
                        <div class="preview-value">${group.roomsPicked} rooms</div>
                    </div>` : ''}
                    ${group.contactName ? `<div class="preview-row">
                        <div class="preview-label">Contact:</div>
                        <div class="preview-value">${group.contactName}</div>
                    </div>` : ''}
                    ${group.contactPhone ? `<div class="preview-row">
                        <div class="preview-label">Phone:</div>
                        <div class="preview-value">${group.contactPhone}</div>
                    </div>` : ''}
                    ${group.contactEmail ? `<div class="preview-row">
                        <div class="preview-label">Email:</div>
                        <div class="preview-value">${group.contactEmail}</div>
                    </div>` : ''}
                    ${group.vipNames ? `<div class="preview-row">
                        <div class="preview-label">VIP Names:</div>
                        <div class="preview-value" style="white-space: pre-wrap;">${group.vipNames}</div>
                    </div>` : ''}
                    ${group.specialRequests ? `<div class="preview-row">
                        <div class="preview-label">Special Requests:</div>
                        <div class="preview-value" style="white-space: pre-wrap;">${group.specialRequests}</div>
                    </div>` : ''}
                `;
                container.appendChild(preview);
            });

            // Hide processing, show preview
            document.getElementById('processingSection').classList.remove('show');
            document.getElementById('previewGroups').classList.add('show');

            showAlert('success', `Successfully extracted ${extractedGroups.length} group(s) from document!`);
        }

        // Save extracted groups
        window.saveExtractedGroups = async function() {
            try {
                showAlert('success', 'Saving groups to database...');

                for (const group of extractedGroups) {
                    const groupData = {
                        ...group,
                        createdAt: new Date().toISOString(),
                        updatedAt: new Date().toISOString(),
                        createdBy: currentUser?.email || 'Unknown'
                    };

                    await addDoc(collection(db, 'groups'), groupData);
                }

                showAlert('success', `Successfully saved ${extractedGroups.length} group(s)!`);
                
                // Reset and reload
                cancelUpload();
                await loadGroups();

            } catch (error) {
                console.error('Save error:', error);
                showAlert('error', `Failed to save groups: ${error.message}`);
            }
        };

        // Cancel upload
        window.cancelUpload = function() {
            selectedFile = null;
            extractedGroups = [];
            document.getElementById('fileInput').value = '';
            document.getElementById('fileInfo').classList.remove('show');
            document.getElementById('processBtn').disabled = true;
            document.getElementById('processingSection').classList.remove('show');
            document.getElementById('previewGroups').classList.remove('show');
            document.getElementById('uploadSection').classList.remove('show');
            hideAllAlerts();
        };

        // Helper function to determine group status
        function getGroupStatus(arrivalDate, departureDate) {
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            
            const arrival = new Date(arrivalDate);
            const departure = new Date(departureDate);
            
            if (today < arrival) return 'upcoming';
            if (today >= arrival && today <= departure) return 'in-house';
            return 'past';
        }

        // Format date for display
        function formatDate(dateString) {
            if (!dateString) return 'N/A';
            const date = new Date(dateString);
            return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
        }

        // Load groups from Firestore
        async function loadGroups() {
            try {
                const groupsRef = collection(db, 'groups');
                const q = query(groupsRef, orderBy('arrivalDate', 'asc'));
                const querySnapshot = await getDocs(q);

                allGroups = [];
                querySnapshot.forEach((doc) => {
                    allGroups.push({
                        id: doc.id,
                        ...doc.data()
                    });
                });

                displayGroups(allGroups);
            } catch (error) {
                console.error('Error loading groups:', error);
                document.getElementById('groupsGrid').innerHTML = 
                    '<div class="no-groups"><div class="no-groups-icon">‚ö†Ô∏è</div><p>Error loading groups. Please refresh the page.</p></div>';
            }
        }

        // Display groups
        function displayGroups(groups) {
            const grid = document.getElementById('groupsGrid');
            
            if (groups.length === 0) {
                grid.innerHTML = '<div class="no-groups"><div class="no-groups-icon">üìã</div><p>No groups found. Click "Add Group" to create one.</p></div>';
                return;
            }

            grid.innerHTML = '';
            groups.forEach(group => {
                const status = getGroupStatus(group.arrivalDate, group.departureDate);
                const statusClass = `status-${status}`;
                const statusText = status.charAt(0).toUpperCase() + status.slice(1).replace('-', ' ');

                const card = document.createElement('div');
                card.className = 'group-card';
                card.innerHTML = `
                    <div class="group-card-header">
                        <div>
                            <div class="group-name">${group.groupName}</div>
                            ${group.company ? `<div style="font-size: 14px; color: #666;">${group.company}</div>` : ''}
                        </div>
                        <span class="status-badge ${statusClass}">${statusText}</span>
                    </div>
                    <div class="group-dates">
                        üìÖ ${formatDate(group.arrivalDate)} - ${formatDate(group.departureDate)}
                    </div>
                    <div class="group-info">
                        ${group.roomBlock ? `<div class="group-info-row"><span class="group-info-label">Room Block:</span>${group.roomBlock} rooms</div>` : ''}
                        ${group.roomsPicked ? `<div class="group-info-row"><span class="group-info-label">Picked Up:</span>${group.roomsPicked} rooms</div>` : ''}
                        ${group.contactName ? `<div class="group-info-row"><span class="group-info-label">Contact:</span>${group.contactName}</div>` : ''}
                        ${group.contactPhone ? `<div class="group-info-row"><span class="group-info-label">Phone:</span>${group.contactPhone}</div>` : ''}
                    </div>
                    <div class="action-buttons">
                        <button class="btn-small btn-view" onclick="viewGroup('${group.id}')">üëÅÔ∏è View Details</button>
                        ${currentUserProfile?.role === 'Admin' || currentUserProfile?.role === 'Manager' ? 
                            `<button class="btn-small btn-edit" onclick="editGroup('${group.id}')">‚úèÔ∏è Edit</button>
                             <button class="btn-small btn-delete" onclick="deleteGroup('${group.id}', '${group.groupName}')">üóëÔ∏è Delete</button>` 
                            : ''}
                    </div>
                `;
                grid.appendChild(card);
            });
        }

        // Filter and search
        function filterGroups() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const statusFilter = document.getElementById('statusFilter').value;

            let filtered = allGroups;

            // Filter by status
            if (statusFilter !== 'all') {
                filtered = filtered.filter(group => 
                    getGroupStatus(group.arrivalDate, group.departureDate) === statusFilter
                );
            }

            // Filter by search term
            if (searchTerm) {
                filtered = filtered.filter(group =>
                    (group.groupName?.toLowerCase().includes(searchTerm)) ||
                    (group.company?.toLowerCase().includes(searchTerm)) ||
                    (group.contactName?.toLowerCase().includes(searchTerm))
                );
            }

            displayGroups(filtered);
        }

        // Event listeners for search and filter
        document.getElementById('searchInput').addEventListener('input', filterGroups);
        document.getElementById('statusFilter').addEventListener('change', filterGroups);

        // Open add group modal
        window.openAddGroupModal = function() {
            editingGroupId = null;
            document.getElementById('modalTitle').textContent = 'Add New Group';
            document.getElementById('groupForm').reset();
            document.getElementById('groupModal').classList.add('active');
        };

        // Close modal
        window.closeModal = function() {
            document.getElementById('groupModal').classList.remove('active');
            editingGroupId = null;
        };

        // Close view modal
        window.closeViewModal = function() {
            document.getElementById('viewModal').classList.remove('active');
        };

        // Close modals when clicking outside
        document.getElementById('groupModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeModal();
            }
        });

        document.getElementById('viewModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeViewModal();
            }
        });

        // View group details
        window.viewGroup = function(groupId) {
            const group = allGroups.find(g => g.id === groupId);
            if (!group) return;

            const status = getGroupStatus(group.arrivalDate, group.departureDate);
            const statusClass = `status-${status}`;
            const statusText = status.charAt(0).toUpperCase() + status.slice(1).replace('-', ' ');

            let content = `
                <div class="detail-section">
                    <div class="detail-dates">
                        üìÖ ${formatDate(group.arrivalDate)} - ${formatDate(group.departureDate)}
                    </div>
                    <span class="status-badge ${statusClass}" style="display: inline-block; margin-top: 10px;">${statusText}</span>
                </div>
            `;

            if (group.company) {
                content += `
                    <div class="detail-section">
                        <div class="detail-label">Company/Organization</div>
                        <div class="detail-value">${group.company}</div>
                    </div>
                `;
            }

            if (group.roomBlock || group.roomsPicked) {
                content += `<div class="detail-section">`;
                if (group.roomBlock) {
                    content += `
                        <div class="detail-label">Room Block</div>
                        <div class="detail-value">${group.roomBlock} rooms</div>
                    `;
                }
                if (group.roomsPicked) {
                    content += `
                        <div class="detail-label">Rooms Picked Up</div>
                        <div class="detail-value">${group.roomsPicked} rooms</div>
                    `;
                }
                content += `</div>`;
            }

            if (group.contactName || group.contactPhone || group.contactEmail) {
                content += `<div class="detail-section">`;
                content += `<div class="detail-label">Primary Contact</div>`;
                if (group.contactName) {
                    content += `<div class="detail-value"><strong>Name:</strong> ${group.contactName}</div>`;
                }
                if (group.contactPhone) {
                    content += `<div class="detail-value"><strong>Phone:</strong> ${group.contactPhone}</div>`;
                }
                if (group.contactEmail) {
                    content += `<div class="detail-value"><strong>Email:</strong> <a href="mailto:${group.contactEmail}" style="color: var(--embassy-blue);">${group.contactEmail}</a></div>`;
                }
                content += `</div>`;
            }

            if (group.vipNames) {
                content += `
                    <div class="detail-section">
                        <div class="detail-label">VIP Names</div>
                        <div class="vip-box">${group.vipNames}</div>
                    </div>
                `;
            }

            if (group.specialRequests) {
                content += `
                    <div class="detail-section">
                        <div class="detail-label">Special Requests / Notes</div>
                        <div class="notes-box">${group.specialRequests}</div>
                    </div>
                `;
            }

            document.getElementById('viewModalTitle').textContent = group.groupName;
            document.getElementById('viewModalContent').innerHTML = content;
            document.getElementById('viewModal').classList.add('active');
        };

        // Edit group
        window.editGroup = function(groupId) {
            const group = allGroups.find(g => g.id === groupId);
            if (!group) return;

            editingGroupId = groupId;
            document.getElementById('modalTitle').textContent = 'Edit Group';
            document.getElementById('groupName').value = group.groupName || '';
            document.getElementById('company').value = group.company || '';
            document.getElementById('arrivalDate').value = group.arrivalDate || '';
            document.getElementById('departureDate').value = group.departureDate || '';
            document.getElementById('roomBlock').value = group.roomBlock || '';
            document.getElementById('roomsPicked').value = group.roomsPicked || '';
            document.getElementById('contactName').value = group.contactName || '';
            document.getElementById('contactPhone').value = group.contactPhone || '';
            document.getElementById('contactEmail').value = group.contactEmail || '';
            document.getElementById('vipNames').value = group.vipNames || '';
            document.getElementById('specialRequests').value = group.specialRequests || '';
            
            document.getElementById('groupModal').classList.add('active');
        };

        // Delete group
        window.deleteGroup = async function(groupId, groupName) {
            if (!confirm(`Are you sure you want to delete "${groupName}"? This cannot be undone.`)) {
                return;
            }

            try {
                await deleteDoc(doc(db, 'groups', groupId));
                showAlert('success', 'Group deleted successfully!');
                await loadGroups();
            } catch (error) {
                console.error('Error deleting group:', error);
                showAlert('error', 'Error deleting group. Please try again.');
            }
        };

        // Form submission
        document.getElementById('groupForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const submitBtn = document.getElementById('submitBtn');
            submitBtn.disabled = true;
            submitBtn.textContent = 'Saving...';

            const groupData = {
                groupName: document.getElementById('groupName').value,
                company: document.getElementById('company').value,
                arrivalDate: document.getElementById('arrivalDate').value,
                departureDate: document.getElementById('departureDate').value,
                roomBlock: parseInt(document.getElementById('roomBlock').value) || null,
                roomsPicked: parseInt(document.getElementById('roomsPicked').value) || null,
                contactName: document.getElementById('contactName').value,
                contactPhone: document.getElementById('contactPhone').value,
                contactEmail: document.getElementById('contactEmail').value,
                vipNames: document.getElementById('vipNames').value,
                specialRequests: document.getElementById('specialRequests').value,
                updatedAt: new Date().toISOString()
            };

            try {
                if (editingGroupId) {
                    // Update existing group
                    await updateDoc(doc(db, 'groups', editingGroupId), groupData);
                    showAlert('success', 'Group updated successfully!');
                } else {
                    // Add new group
                    groupData.createdAt = new Date().toISOString();
                    groupData.createdBy = currentUser?.email || 'Unknown';
                    await addDoc(collection(db, 'groups'), groupData);
                    showAlert('success', 'Group added successfully!');
                }

                closeModal();
                await loadGroups();

            } catch (error) {
                console.error('Error saving group:', error);
                showAlert('error', 'Error saving group. Please try again.');
            }

            submitBtn.disabled = false;
            submitBtn.textContent = 'Save Group';
        });

        // Alert functions
        function showAlert(type, message) {
            hideAllAlerts();
            if (type === 'success') {
                document.getElementById('alertSuccess').textContent = '‚úì ' + message;
                document.getElementById('alertSuccess').classList.add('show');
                setTimeout(hideAllAlerts, 5000);
            } else if (type === 'error') {
                document.getElementById('alertError').textContent = '‚ö† ' + message;
                document.getElementById('alertError').classList.add('show');
            }
        }

        function hideAllAlerts() {
            document.getElementById('alertSuccess').classList.remove('show');
            document.getElementById('alertError').classList.remove('show');
        }

        // Check authentication and permissions
        onAuthStateChanged(auth, async (user) => {
            if (!user) {
                window.location.href = 'firebase-login.html';
                return;
            }

            // Store current user
            currentUser = user;

            try {
                const userDoc = await getDoc(doc(db, 'users', user.uid));
                
                if (!userDoc.exists()) {
                    alert('User profile not found.');
                    window.location.href = 'firebase-login.html';
                    return;
                }

                currentUserProfile = userDoc.data();

                // Check if user has viewGroupGuide permission
                const hasPermission = currentUserProfile.role === 'Admin' || 
                                    currentUserProfile.role === 'Manager' ||
                                    (currentUserProfile.permissions && currentUserProfile.permissions.viewGroupGuide);

                if (!hasPermission) {
                    alert('Access denied. You do not have permission to view the Group Guide.');
                    window.location.href = 'index.html';
                    return;
                }

                // Show Add Group and AI Upload buttons for Admin/Manager only
                if (currentUserProfile.role === 'Admin' || currentUserProfile.role === 'Manager') {
                    document.getElementById('addGroupBtn').style.display = 'block';
                    document.getElementById('aiUploadBtn').style.display = 'block';
                }

                // Load groups
                await loadGroups();

                // Show page
                document.getElementById('loading').style.display = 'none';
                document.getElementById('groupGuidePage').style.display = 'block';

            } catch (error) {
                console.error('Error:', error);
                alert('Error loading page. Please try again.');
                window.location.href = 'index.html';
            }
        });
    </script>
</body>
</html>
